<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jess Empadas #home</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='fontawesome/css/all.min.css') }}">
</head>
<body>
<header>
    <nav>
        <img id="logo" src="{{ url_for('static', filename='img/logo.png') }}">
        <div id="P">
            <form method="GET" action="{{ url_for('home') }}" class="search-form">
                <input type="text" name="q" placeholder="Pesquisa..." value="{{ termo_pesquisa or '' }}">
                <button type="submit">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
            </form>
        </div>                           
        <div id="inverte">
            <div id="F">
                {% if current_user.is_authenticated %}
                    <a href="{{ url_for('logout') }}" class="logout-btn" title="Sair">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </a>
                {% else %}
                    <form method="GET" action="{{ url_for('login') }}">
                        <button type="submit" name="user" title="Login">
                            <i class="fa-solid fa-user"></i>
                        </button> 
                    </form>
                {% endif %}
                
                <form method="POST" action="{{ url_for('carrinho_ver') }}">
                    <button type="submit" name="carrinho" title="Carrinho">
                        <i class="fa-solid fa-cart-shopping"></i>
                    </button>
                </form>
            </div>
            <i id="burguer" onclick="clickMenu()"><i class="fa-solid fa-bars"></i></i>
            <div id="overlay">
                <div id="itens" class="menu">
                    <a href="#" onclick="clickMenu()">Home</a>
                    <a href="#produtos" onclick="clickMenu()">Produtos</a>
                    <a href="#sobre-loja" onclick="clickMenu()">Sobre</a>
                    <a href="#footer" onclick="clickMenu()">Contato</a>
                </div> 
            </div>                
        </div>
    </nav>
</header>

<script>
function clickMenu() {
    var overlay = document.getElementById('overlay');
    var itens = document.getElementById('itens');
    if (overlay.style.display == 'block') {
        overlay.style.display = "none";
        itens.style.display = 'block';
    } else {
        overlay.style.display = "block";
    }
}
</script>

<main>
    {% if tipo_usuario == 'fornecedor' %}
    <section id="painel-fornecedor-topo">
        <h2><i class="fa-solid fa-chart-line"></i> Painel do Fornecedor</h2>

        <div class="painel-botoes">
            <a href="{{ url_for('cadastroProduto') }}" class="btn-acao">
                <i class="fa-solid fa-plus"></i> Cadastrar Produto
            </a>
            <a href="{{ url_for('cadastroFornecedor') }}" class="btn-acao" id="topo">
                <i class="fa-solid fa-user-plus"></i> Cadastrar Fornecedor
            </a>
        </div>

        <div class="painel-produtos">
            {% for produto in produtos %}
            <div class="painel-card {% if produto.validade_proxima %}alerta-validade{% endif %}">
                <img src="{{ produto.imagem }}" alt="{{ produto.nome }}">
                <div class="painel-info">
                    <h3>{{ produto.nome }}</h3>
                    <p>Preço: R$ {{ produto.valor }}</p>
                    <p>Categoria: {{ produto.categoria }}</p>
                    <p>Validade: {{ produto.validade }}</p>
                    {% if produto.validade_proxima %}
                        <span class="badge-alerta">⚠ Validade próxima</span>
                    {% endif %}
                </div>
        
                <div class="painel-acoes">
                    <button type="button" class="btn-acao" 
                            onclick="abrirModalEditar('{{ produto.codproduto }}', '{{ produto.nome }}', '{{ produto.descricao }}', '{{ produto.valor }}', '{{ produto.validade }}', '{{ produto.quantidade }}', '{{ produto.categoria }}')">
                        <i class="fa-solid fa-pen"></i> Editar
                    </button>
        
                    <form method="POST" action="{{ url_for('deletarProduto', codproduto=produto.codproduto) }}" onsubmit="return confirm('Tem certeza que deseja deletar este produto?')">
                        <button type="submit" class="btn-acao delete">
                            <i class="fa-solid fa-trash"></i> Deletar
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>             
    </section>
    {% else %}
    <!-- HERO só aparece para usuários não fornecedores -->
    <section id="hero">
        <div class="hero-content">
            <h1>Jess Empadas</h1>
            <p>Transformando cada dia em um momento doce!</p>
            <a href="#produtos" class="btn-hero">Ver Produtos</a>
        </div>
    </section>
    {% endif %}
    <!-- FAZER COM BASE NAS VENDAS REAIS
    <section id="destaques">
        <h2>Mais Vendidos</h2>
        <div class="produtos-grid">
            {% for produto in mais_vendidos %}
            <a href="javascript:void(0)" class="card-produto destaque" data-product
               data-id="{{ produto.codproduto }}"
               data-name="{{ produto.nome }}"
               data-image="{{ produto.imagem }}"
               data-price="{{ produto.valor }}"
               data-desc="{{ produto.descricao }}">
                <div class="card-imgP">
                    <img src="{{ produto.imagem }}" alt="{{ produto.nome }}">
                </div>
                <div class="nomeP">{{ produto.nome }}</div>
            </a>
            {% endfor %}
        </div>              
    </section>
    -->

    {% if termo_pesquisa %}
        <h2>Resultados para "{{ termo_pesquisa }}":</h2>
        {% if produtos|length == 0 %}
            <p>Nenhum produto encontrado.</p>
        {% endif %}
    {% endif %}

    <section id="produtos">
        {% for categoria, lista in {'Doces': doces, 'Salgados': salgados}.items() %}
            <h2>{{ categoria }}</h2>
            <div class="produtos-grid">
                {% for produto in lista %}
                <div class="card-produto" data-product
                     data-id="{{ produto.codproduto }}"
                     data-name="{{ produto.nome }}"
                     data-image="{{ produto.imagem }}"
                     data-price="{{ '%.2f'|format(produto.valor) }}"
                     data-desc="{{ produto.descricao }}">
              
                    <div class="card-imgP">
                        <img src="{{ produto.imagem }}" alt="{{ produto.nome }}">
                    </div>
              
                    <div class="card-info">
                        <h3>{{ produto.nome }}</h3>
                        <p class="desc">{{ produto.descricao }}</p>
              
                        <div class="card-footer">
                            <span class="preco">R$ {{ '%.2f'|format(produto.valor) }}</span>
                            <button class="btn-produto" type="button">Ver Produto</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
              </div>                  
        {% endfor %}
    </section>
    

    <section id="sobre-loja">
        <div class="sobre-conteudo">
            <h2>Como Surgimos?</h2>
            <p> A "Jess Empadas" começou em julho de 2023, no IFCM, onde vendi minhas primeiras empadas doces tradicionais. Mas, a história desse sonho começou bem antes. Desde muito nova, eu era apaixonada por fazer doces. Com 14 anos esse desejo plantou-se em meu coração mas, acabei deixando-o de lado... O desejo de ter uma renda fazendo algo que amava crescia, mas a insegurança e o medo me impediam, mesmo com o apoio da minha família.</p>
            <p> Quatro anos depois, fiz empadas doces para minha amiga que já trabalhava com doces. Ela adorou e disse: <strong>"Você precisa vender isso!".</strong> Contei a ela sobre os meus medos e, ela se ofereceu para me ajudar a vender. No dia seguinte, ela me pegou pela mão e, em menos de 30 minutos, vendemos tudo. <strong>Esse momento foi crucial para vencer o medo e perseguir meu sonho. </strong></p>
            <p>Aqui estou, dando continuidade a esse sonho, que cada vez vem tomando mais forma. Tenho aprendido com a "Jess Empadas" que ter coragem para ir adiante, mesmo com medo, pode resultar em algo lindo e gratificante.</p>
            <div class="sobre-cards">
                <div class="card-sobre">
                    <img src="{{ url_for('static', filename='img/produção1.jpeg') }}" alt="produção">
                    <p>Primeira fornada de empadas</p>
                </div>
                <div class="card-sobre">
                    <img src="{{ url_for('static', filename='img/banner.png') }}" alt="criei minha logo">
                    <p>Criação da Identidade Visual</p>
                </div>
                <div class="card-sobre">
                    <img src="{{ url_for('static', filename='img/jessekelly.jpeg') }}" alt="Jess e amiga">
                    <p>Jess & Kelly: primeiras vendas</p>
                </div>
            </div>
        </div>
    </section>
</main>

<footer id="footer">
    <div class="footer-content">
        <img id="logoF" src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo da Sua Empresa">
        <div class="contact-info">
            <div>
                <h3 class="title">Contato</h3>
                <p class="info">Delivery e Eventos:</p>
                <p class="info">(XX) XXXXX-XXXX</p>
            </div>
            <div id="ig">
                <div id="simbIG">
                    <a href="https://www.instagram.com/jess.empadas/" target="_blank"><i class="fa-brands fa-instagram"></i></a>
                </div>
                <div>
                    <h4 class="title">@jess.empadas</h4>
                    <p class="info">Desde 2023 © Jess Empadas</p>
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- MODAL PRODUTO -->
<div class="modal-overlay" id="productModal" style="display:none;">
    <div class="modal" role="document">
        <div class="modal-header">
            <h2 class="modal-title">Produto</h2>
            <button class="modal-close" aria-label="Fechar">&times;</button>
        </div>
        <div class="modal-body">
            <div class="img-wrap">
                <img src="" alt="" class="modal-img">
            </div>
            <div class="modal-info">
                <h3 class="modal-name"></h3>
                <hr>
                <ul class="modal-desc"></ul>
                <p class="modal-price"></p>
                <form id="modalCartForm" action="{{ url_for('carrinho_adicionar') }}" method="POST" class="modal-cart">
                    <input type="hidden" name="produto_id" value="">
                    <button type="submit" class="btn-add-cart">
                        <i class="fa-solid fa-cart-plus"></i> Adicionar ao Carrinho
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- MODAL EDIÇÃO DE PRODUTO -->
<div id="modalEditar" class="modal-editar">
    <div class="modal-editar-content">
        <span class="modal-editar-fechar" onclick="fecharModalEditar()">&times;</span>
        <h2>Editar Produto</h2>
        <form id="formEditar" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="codproduto" id="editCodproduto">
    
            <label>Nome:</label>
            <input type="text" name="nome" id="editNome" required>
    
            <label>Descrição:</label>
            <textarea name="descricao" id="editDescricao" required></textarea>
    
            <label>Preço:</label>
            <input type="number" step="0.01" name="valor" id="editValor" required>
    
            <label>Validade:</label>
            <input type="date" name="vencimento" id="editValidade" required>
    
            <label>Quantidade:</label>
            <input type="number" name="quantidade" id="editQuantidade" required>
    
            <label>Categoria:</label>
            <input type="text" name="categoria" id="editCategoria" required>
    
            <label>Imagem:</label>
            <input type="file" name="img">
    
            <button type="submit" class="btn-salvar">Salvar Alterações</button>
        </form>
    </div>
</div>

<script> // abrir modal produto e add produtos ao carrinho
    document.addEventListener('DOMContentLoaded', function () {
    const overlay   = document.getElementById('productModal'); 
    const closeBtn  = overlay.querySelector('.modal-close');
    const titleEl   = overlay.querySelector('.modal-title');
    const nameEl    = overlay.querySelector('.modal-name');
    const imgEl     = overlay.querySelector('.modal-img');
    const descEl    = overlay.querySelector('.modal-desc');
    const priceEl   = overlay.querySelector('.modal-price');
    const cartForm  = document.getElementById('modalCartForm');
    const idInput   = cartForm.querySelector('input[name="produto_id"]');

    // converte string de descrição em array
    function parseDesc(raw) {
        if (!raw) return [];
        try {
            const j = JSON.parse(raw);
            if (Array.isArray(j)) return j;
        } catch(e){}
        return String(raw).split('||').map(s => s.trim()).filter(Boolean);
    }

    function openModal(data){
        const { id='', name='Produto', image='', price='', desc='' } = data;
        titleEl.textContent = 'Detalhes do Produto';
        nameEl.textContent  = name;
        imgEl.src           = image || '';
        imgEl.alt           = name;

        descEl.innerHTML = '';
        parseDesc(desc).forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            descEl.appendChild(li);
        });

        priceEl.textContent = price ? `R$ ${price}` : '';
        idInput.value = id;

        overlay.style.display = 'flex'; 
        overlay.setAttribute('aria-hidden', 'false');
        closeBtn.focus();
    }

    function closeModal(){
        overlay.style.display = 'none';
        overlay.setAttribute('aria-hidden', 'true');
    }

    closeBtn.addEventListener('click', closeModal);
    overlay.addEventListener('click', e => { if (e.target === overlay) closeModal(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

    // abre modal ao clicar em produtos
    document.querySelectorAll('[data-product]').forEach(el => {
        el.addEventListener('click', function (ev) {
            ev.preventDefault();
            const d = this.dataset;
            openModal({
                id: d.id || '',
                name: d.name || (this.querySelector('h3')?.textContent?.trim() || 'Produto'),
                image: d.image || (this.querySelector('img')?.src || ''),
                price: d.price || '',
                desc: d.desc || ''
            });
        });
    });

    // AJAX para adicionar ao carrinho
    cartForm.addEventListener('submit', function (ev) {
        ev.preventDefault();
        const produtoId = idInput.value;
        if (!produtoId) {
            alert('Produto inválido!');
            return;
        }

        const formData = new FormData();
        formData.append('produto_id', produtoId);

        fetch(cartForm.action, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                closeModal();
            } else {
                alert(data.error || 'Erro ao adicionar ao carrinho.');
            }
        })
        .catch(err => {
            console.error(err);
            alert('Erro ao adicionar ao carrinho.');
        });
    });
});

</script>
    

<script> // abrir modal edição de produtos
    document.addEventListener('DOMContentLoaded', function () {
      const modalEditar = document.getElementById('modalEditar');
      const formEditar  = document.getElementById('formEditar');
      const btnFechar   = document.querySelector('.modal-editar-fechar');
      const btnSalvar   = formEditar.querySelector('.btn-salvar');
    
      const fCod   = document.getElementById('editCodproduto');
      const fNome  = document.getElementById('editNome');
      const fDesc  = document.getElementById('editDescricao');
      const fValor = document.getElementById('editValor');
      const fVal   = document.getElementById('editValidade');
      const fQtd   = document.getElementById('editQuantidade');
      const fCat   = document.getElementById('editCategoria');
    
      // dd/mm/aaaa -> aaaa-mm-dd (p/ <input type="date">)
      function brToISO(dataBR) {
        if (!dataBR) return '';
        const [dd, mm, yyyy] = String(dataBR).split('/');
        if (!yyyy) return '';
        return `${yyyy}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
      }
    
      // normaliza num com vírgula para ponto (caso seja "12,50")
      function toNumberString(v) {
        if (v === null || v === undefined) return '';
        return String(v).replace(',', '.');
      }
    
      // monta a url de edição dinamicamente
      const EDIT_URL_TEMPLATE = "{{ url_for('editarProduto', codproduto='CODPLACEHOLDER') }}";
    
      window.abrirModalEditar = function (codproduto, nome, descricao, valor, validade, quantidade, categoria) {
        // Preenche campos
        fCod.value   = codproduto || '';
        fNome.value  = nome || '';
        fDesc.value  = descricao || '';
        fValor.value = toNumberString(valor) || '';
        fVal.value   = brToISO(validade || '');
        fQtd.value   = quantidade || '';
        fCat.value   = categoria || '';
    
        formEditar.action = EDIT_URL_TEMPLATE.replace('CODPLACEHOLDER', encodeURIComponent(codproduto || ''));
    
        // exibe modal
        modalEditar.style.display = 'flex'; 
        modalEditar.setAttribute('aria-hidden', 'false');
        btnSalvar.disabled = false;
      };
    
      window.fecharModalEditar = function () {
        modalEditar.style.display = 'none';
        modalEditar.setAttribute('aria-hidden', 'true');
      };
    
      // fechar ao clicar fora
      modalEditar.addEventListener('click', (e) => {
        if (e.target === modalEditar) window.fecharModalEditar();
      });
    
      // fechar com x
      btnFechar.addEventListener('click', window.fecharModalEditar);
    
      // fechar com esc
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') window.fecharModalEditar();
      });
    
      // evita duplo submit 
      formEditar.addEventListener('submit', function () {
        btnSalvar.disabled = true;
        const original = btnSalvar.textContent;
        btnSalvar.textContent = 'Salvando...';
        setTimeout(() => {
          btnSalvar.disabled = false;
          btnSalvar.textContent = original;
        }, 5000);
      });
    });
</script>
    

</body>
</html>
